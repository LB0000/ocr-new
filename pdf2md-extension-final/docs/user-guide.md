# PDF→Excel 履歴書変換システム - 拡張機能ドキュメント

## 概要

このドキュメントでは、既存のPDF→Markdown変換システムに追加された「履歴書PDFをOCRし、Excelテンプレートに転記する機能」について説明します。

## 新機能

1. **マッピングプリセット機能**
   - よく使う履歴書フォーマットごとにマッピングパターンを保存・再利用
   - ローカルストレージを使用したプリセット管理

2. **AI自動フィールド推定機能**
   - OCR結果の各行を分析し、「氏名」「住所」などを自動推定
   - 信頼度スコアリングと閾値調整機能

3. **Excel出力プレビュー機能**
   - マッピングされたデータがExcelのどのセルに配置されるかを視覚化
   - 簡易表示と詳細表示の2つのモード

## 使用方法

### 1. PDFアップロード

1. トップページ（`/`）にアクセス
2. 「PDFをアップロード」ボタンをクリックし、履歴書PDFを選択
3. アップロード完了後、OCR処理が自動的に開始

### 2. OCR結果のマッピング

1. OCR処理完了後、「Excelマッピング画面へ進む」ボタンをクリック
2. マッピング画面（`/map`）に遷移
3. 以下のいずれかの方法でマッピングを行う：
   - **AI自動マッピング**: 「AIによる自動マッピング」ボタンをクリック
   - **プリセット適用**: 保存済みのプリセットから選択
   - **手動マッピング**: 各行の右側のドロップダウンからフィールドを選択

### 3. マッピングの調整

1. 自動マッピングの結果を確認し、必要に応じて手動で調整
2. テキスト内容を編集する場合は、テキストエリアを直接編集
3. 複数行を結合する場合：
   - 結合したい行のチェックボックスを選択
   - 「フィールドを選択して結合」ドロップダウンから結合先のフィールドを選択

### 4. マッピングの保存（オプション）

1. 現在のマッピングをプリセットとして保存する場合：
   - プリセット名を入力
   - 「保存」ボタンをクリック

### 5. Excel出力

1. マッピング結果を確認（「Excelプレビューを表示」ボタンでプレビュー可能）
2. 「Excelに出力」ボタンをクリック
3. 生成されたExcelファイルが自動的にダウンロード

## 機能詳細

### マッピングプリセット機能

プリセットは、特定のPDFフォーマットに対するマッピングパターンを保存し、同様のフォーマットのPDFを処理する際に再利用するための機能です。

- **保存**: 現在のマッピングをプリセットとして保存
- **適用**: 保存済みのプリセットを現在のOCR結果に適用
- **削除**: 不要になったプリセットを削除

プリセットはブラウザのローカルストレージに保存されるため、ブラウザのデータをクリアすると失われます。

### AI自動フィールド推定機能

OCR結果の各行を分析し、内容に基づいて適切なフィールドを推定する機能です。

- **推定ロジック**: 正規表現パターンと特徴分析を組み合わせたアルゴリズム
- **信頼度スコア**: 各推定結果に0〜1の信頼度スコアを付与
- **閾値調整**: スライダーで信頼度閾値を調整可能（デフォルト: 0.7）
- **推定結果表示**: 「予測結果を表示」ボタンで詳細な推定結果を確認可能

### Excel出力プレビュー機能

マッピングされたデータがExcelのどのセルに配置されるかを視覚化する機能です。

- **簡易表示**: フィールド、セル位置、内容を一覧表示
- **詳細表示**: Excelのレイアウトを模したビジュアルプレビュー
- **切替**: 「詳細表示に切り替え」/「簡易表示に切り替え」ボタンで表示モードを切替

## セルマッピング

以下は、各フィールドがExcelテンプレートのどのセルに対応するかを示します：

| フィールド | セル位置 | 説明 |
|------------|----------|------|
| 氏名 | B3 | 例: 山田 太郎 |
| ふりがな | B2 | 例: やまだ たろう |
| 生年月日 | B5 | 例: 1990年1月1日生 (満33歳) |
| 住所 | B7 | 例: 東京都新宿区西新宿2-8-1 |
| 電話番号 | F6 | 例: 090-1234-5678 |
| 学歴 | C13 | 例: 2009.4 ○○大学入学... |
| 職歴 | C20 | 例: 2013.4 ○○株式会社入社... |
| 免許・資格 | C26 | 例: 普通自動車第一種運転免許... |
| 自己PR | C30 | 例: 私は... |
| その他 | C34 | その他の情報 |

## トラブルシューティング

### Excel生成に失敗する場合

1. テンプレートファイルが正しく配置されているか確認
   - `templates/履歴書_template.xlsx` が存在するか確認

2. マッピングが正しく行われているか確認
   - 少なくとも1つのフィールドがマッピングされている必要があります

3. ブラウザのコンソールでエラーメッセージを確認

### 自動マッピングの精度が低い場合

1. 信頼度閾値を調整
   - 閾値を下げると多くのフィールドが自動マッピングされますが、誤判定も増加
   - 閾値を上げると精度は向上しますが、自動マッピングされるフィールドは減少

2. OCR結果の品質を確認
   - PDFの品質が低い場合、OCR結果の精度も低下
   - スキャンPDFの場合、解像度が300dpi以上あることが望ましい

## 技術仕様

- **フロントエンド**: Next.js (App Router) + React + TypeScript
- **OCR処理**: Mistral AI OCR SDK
- **Excel生成**: exceljs
- **ストレージ**: Vercel Blob (PDF保存), LocalStorage (プリセット保存)

## 今後の拡張予定

- 複数テンプレート対応
- 機械学習を活用した自動フィールド推定の精度向上
- 複数PDFの一括処理
- 人事システムとの連携API
